# 测试样题组会展示

题目位置：可以在下载区进行下载pdf

测试任务：仅需要完成前三个任务即可

实验平台：本地虚拟机

## 题目要求

1. 所有 Linux 云主机默认开启 SSH 功能，可以通过 CRT 软件连接进行操作。
2. Linux 系统软件安装源文件位于/dev/myiso/目录下，yum 源已开机自动挂载。

**表 1：网络虚拟化系统实训平台网络信息表**

|网络名称|Vlan号|是否共享|子网名称|子网网络地址|网关IP|激活DHCP|地址池范围|
|-|-|-|-|-|-|-|-|
|Vlan301|301|是|Gd301|192.168.21.0/24|192.168.21.254|是|192.168.21.10-20|
|Vlan302|302|是|Gd302|192.168.22.0/24|192.168.22.254|是|192.168.22.10-20|
|Vlan303|303|是|Gd303|192.168.23.0/24|192.168.23.254|是|192.168.23.10-20|

**表 2：网络虚拟化系统实训平台实例信息表**
|实例名称|镜像模板（源）|配置列表|VCPU数量|内存、硬盘信息|网络名称|IP地址|
|-|-|-|-|-|-|-|
|云主机1|Centos7.9|Linux-2440|2|4G、40G|Vlan301|192.168.21.11|
|云主机2|Centos7.9|Linux-2440|2|4G、40G|Vlan301|192.168.21.12|
|云主机3|Centos7.9|Linux-2440|2|4G、40G|Vlan302|192.168.22.13|
|云主机4|Centos7.9|Linux-2440|2|4G、40G|Vlan302|192.168.22.14|
|云主机5|Centos7.9|Linux-2440|2|4G、40G|Vlan303|192.168.23.15|
|云主机6|Centos7.9|Linux-2440|2|4G、40G|Vlan303|192.168.23.16|

### 任务一 网络虚拟化系统实训平台配置

**平台配置要求：**
1. 按照“表 1 网络虚拟化系统实训平台网络信息表”创建 VLAN 网络，并根据“表 2 网络虚拟化系统实训平台云主机信息表”创建云主机。
2. 创建 7 个卷，大小均为 5G，依次命名为“HT1”至“HT7”。

**注意事项：**
1. 在分离卷之前要保证在该卷的 Linux 主机中，已经不存在该卷的任何挂载点，否则会造成分离失败，或是一直显示“分离中”状态。
2. 在实训平台中可以创建多个卷，一个虚拟主机可以同时连接多个卷，但一个卷同时只能给一个虚拟主机作为扩展硬盘使用。
3. 网络虚拟化系统实训平台中的实例 IP 地址及相关参数，默认由 DHCP 进行分配，系统中的 IP 地址一般情况下需要与 DHCP 获取的地址相同，否则会造成网络无法连通。
   
### 任务二 Linux 基础配置
1. 根据下表配置“云主机 1”~“云主机 6”的主机名称。编辑所有云主机的网络适配器配置文件，设置 DNS 服务器的 IP 地址，使其指向“云主机 1”和“云主机 2”的 IP。要求所有 Linux 云主机都能够免密码 ssh 登录到其他 Linux 云主机的 root 用户。

|实例名 |完全域名|
|-|-|
|云主机 1 | dns.2025skills.com|
|云主机 2 |file.2025skills.com|
|云主机 3 |mail.2025skills.com|
|云主机 4 |mariadb.2025skills.com|
|云主机 5 |ntp.2025skills.com|
|云主机 6 |monitor.2025skills.com|

2. 在网络管理员的日常管理维护工作中，经常需要实现快速批量的操作系统进行操作。请在“云主机 1”上创建 99 个用户，用户名从 "Admin01" 到 "Admin99"，设置密码全部为 Guangdong2025,要求每个用户在密码过期之前警告的天数为 7 天，然后将用户添加到 Guangdong 组中，设置账户从不过期和失效。

3. 将 HT1 和 HT2 共 2 个卷挂载到“云主机 5”中，将其加入到名为“GzVG”的卷组中，从中创建一个大小为 8G 的逻辑卷“GzLV”，格式化逻辑卷为 xfs 文件系统并开机自动挂载到/mnt/HT1 目录。

### 任务三 域名服务配置
4. 在“云主机 1”中安装 bind 服务，配置该云主机为主域名服务器，添加2025skills.com 区域，根据主机名称添加对应的主机记录，依次指向“云主机 1”至“云主机 5”，每个记录均需完成正、反向解析，并配置 notify 加快同步速度。
5. 在“云主机 2”中安装 bind 服务，配置该主机为备份域名服务器，与主域名服务器实时同步，将区域文件存储路径设置为/var/named/slaves/。
6. 为增加 DNS 区域传输的安全性，要求使用 TSIG 密钥机制对主服务器和备份服务器之间的区域传输进行身份验证，密钥值在主服务器中手动生成并保存在/root 目录下，身份验证算法为 HMAC-SHA256，只有使用名为“tsig-key”的 TSIG 密钥进行授权的请求才能进行区域传输。

## 解决方案

### 任务一

vmware不支持命令行创建vlan，需要手动先进行配置

打开虚拟机中的虚拟网络编辑器，然后点击更改设置

选择VMnet2：
- 设置子网为192.168.21.0，子网掩码为255.255.255.0
- 点击NAT设置，配置网关为1921.68.21.254
- 点击DHCP设置，设置地址池为192.168.21.10-20

重复上述操作，配置VMent3和VMent4，如下表所示。

|网络名称	|VMnet名称	|VLAN ID|	子网	|网关	|DHCP 池|
|-|-|-|-|-|-|
|Vlan301	|VMnet2	|301	|192.168.21.0/24	|192.168.21.254	|192.168.21.10-20|
|Vlan302	|VMnet3	|302	|192.168.22.0/24	|192.168.22.254	|192.168.22.10-20|
|Vlan303	|VMnet4	|303	|192.168.23.0/24	|192.168.23.254	|192.168.23.10-20|

然后ubuntu22.04准备iso,或者直接上去下载也是可以的（Well Done）
```bash
# 示例下载命令（需安装 curl）
curl -o "D:\ISO\ubuntu-22.04.4-live-server-amd64.iso" https://releases.ubuntu.com/22.04/ubuntu-22.04.4-live-server-amd64.iso
```

- 创建模板虚拟机目录和虚拟磁盘（Well Done）
```bash
mkdir "D:\VMs\Ubuntu22-Template"
vmware-vdiskmanager.exe -c -s 40GB -t 0 "D:\VMs\Ubuntu22-Template\dist.vmdk"
```

- 文件操作（Well Done）
```bash
type nul > xxx    # 创建空文件
type xxx   # 查看文件内容
copy con xxx # 编辑文件
del xxx 删除文件
```

新建个Ubuntu22-Template.vmx（Well Done）

- 创建虚拟机配置文件（.vmx）
```bash
echo '
config.version = "8"
virtualHW.version = "20"
displayName = "Ubuntu22-Template"
guestOS = "ubuntu-64"
numvcpus = "2"
memsize = "4096"
ide0:0.present = "TRUE"
ide0:0.fileName = "disk.vmdk"
ethernet0.present = "TRUE"
ethernet0.connectionType = "nat"
ide1:0.present = "TRUE"
ide1:0.fileName = "D:\ISO\ubuntu-24.04.2-live-server-amd64.iso"
ide1:0.deviceType = "cdrom-image"
' > "D:\VMs\Ubuntu22-Template\Ubuntu22-Template.vmx"
```

- 启动虚拟机完成安装（Well Done）
```bash
vmrun start "D:\VMs\Ubuntu22-Template\Ubuntu22-Template.vmx"
# 完成安装后关闭
vmrun stop "D:\VMs\Ubuntu22-Template\Ubuntu22-Template.vmx"
```


- 批量创建所有云主机目录及克隆模板.ps1，注意保存格式要是UTF-8 with BOM（不行）
```bash
# 设置控制台输入输出编码为 UTF-8
[Console]::InputEncoding = [System.Text.Encoding]::UTF8
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8

# 定义云主机配置（名称、网络、IP）
$vms = @(
    @{Name="云主机1"; Network="VMnet2"; IP="192.168.21.11"},
    @{Name="云主机2"; Network="VMnet2"; IP="192.168.21.12"},
    @{Name="云主机3"; Network="VMnet3"; IP="192.168.22.13"},
    @{Name="云主机4"; Network="VMnet3"; IP="192.168.22.14"},
    @{Name="云主机5"; Network="VMnet4"; IP="192.168.23.15"},
    @{Name="云主机6"; Network="VMnet4"; IP="192.168.23.16"}
)

$vmrunPath = "D:\vmware\vmware\vmrun.exe"  # 根据实际情况修改路径
if (-not (Test-Path $vmrunPath)) {
    Write-Error "vmrun 命令未找到，请检查路径。"
    return
}

foreach ($vm in $vms) {
    $vmName = $vm.Name
    $vmPath = "D:\VMs\$vmName"
    
    # 创建目录
    try {
        New-Item -ItemType Directory -Path $vmPath -Force -ErrorAction Stop
        Write-Host "成功创建目录: $vmPath"
    }
    catch {
        Write-Error "创建目录 $vmPath 时出错: $($_.Exception.Message)"
        continue
    }
    
    # 克隆模板
    try {
        $templatePath = "D:\VMs\Ubuntu22-Template\Ubuntu22-Template.vmx"
        if (-not (Test-Path $templatePath)) {
            Write-Error "模板文件 $templatePath 不存在，请检查路径。"
            continue
        }
        $cloneCommand = "$vmrunPath clone '$templatePath' '$vmPath\$vmName.vmx' linked"
        $cloneResult = Invoke-Expression $cloneCommand
        if ($LASTEXITCODE -ne 0) {
            throw "克隆操作失败，退出码: $LASTEXITCODE"
        }
        Write-Host "成功克隆模板到: $vmPath\$vmName.vmx"
    }
    catch {
        Write-Error "克隆模板到 $vmPath\$vmName.vmx 时出错: $($_.Exception.Message)"
        continue
    }
    
    # 修改网络适配器配置
    try {
        $filePath = "$vmPath\$vmName.vmx"
        if (Test-Path $filePath) {
            $newContent = (Get-Content $filePath) -replace 'ethernet0.connectionType = "nat"', "ethernet0.connectionType = `"custom`"`nethernet0.vnet = `"$($vm.Network)`""
            $newContent | Set-Content $filePath
            Write-Host "成功修改文件: $filePath"
        }
        else {
            Write-Error "文件 $filePath 不存在。"
        }
    }
    catch {
        Write-Error "修改文件 $filePath 时出错: $($_.Exception.Message)"
    }
}
```

- 配置静态IP地址
```bash
foreach ($vm in $vms) {
    $vmName = $vm.Name
    $vmPath = "D:\VMs\$vmName\$vmName.vmx"
    
    # 启动虚拟机
    vmrun start $vmPath
    
    # 禁用 Cloud-Init 网络管理
    vmrun -gu ubuntu -gp "123456" runProgramInGuest $vmPath "/usr/bin/sudo" "bash -c 'echo ""network: {config: disabled}"" > /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg'"
    
    # 生成 Netplan 配置文件
    $netplanConfig = @"
network:
  version: 2
  ethernets:
    eth0:
      addresses:
        - $($vm.IP)/24
      gateway4: $($vm.Gateway)
      nameservers:
        addresses: [8.8.8.8]
"@
    
    # 写入配置并应用
    vmrun -gu ubuntu -gp "123456" runProgramInGuest $vmPath "/usr/bin/sudo" "bash -c 'echo ''$netplanConfig'' > /etc/netplan/01-static.yaml'"
    vmrun -gu ubuntu -gp "123456" runProgramInGuest $vmPath "/usr/bin/sudo" "netplan apply"
    
    # 关闭虚拟机
    vmrun stop $vmPath
}
```

- 创建7个卷（Well Done）
```bash
foreach ($i in 1..7) {
    vmware-vdiskmanager.exe -c -s 5GB -t 0 "HT$i" 
}
```

- 查看已经创建了的卷（Well Done）
```bash
# 直接列出当前目录下的文件
Get-ChildItem -Path . -Filter "HT*"
```


- 检查虚拟网络
```bash
vmrun start "D:\VMs\云主机1\云主机1.vmx"
vmrun -gu ubuntu -gp "123456" runProgramInGuest "D:\VMs\云主机1\云主机1.vmx" "ip a"
```


### 任务二

1. 配置主机名、网络适配器和SSH免密登录

vmrun登录云主机，每一台都要相应修改
```bash
# 从宿主机（Windows）登录到云主机1（假设IP为192.168.21.11）
vmrun -gu ubuntu -gp "123456" runProgramInGuest "D:\VMs\云主机1\云主机1.vmx" "/usr/bin/sudo" "bash"
```

- 配置主机名,按照具体要求进行配置
```bash
sudo hostnamectl set-hostname dns.2025skills.com
```

- 配置域名解析
```bash
sudo vim /etc/hosts
```

或者
```bash
echo '
192.168.21.11 dns.2025skills.com
192.168.21.12 file.2025skills.com
192.168.22.13 mail.2025skills.com
192.168.22.14 mariadb.2025skills.com
192.168.23.15 ntp.2025skills.com
192.168.23.16 monitor.2025skills.com
' >> /etc/hosts
```

- 验证修改
```bash
hostnamectl
ping file.2025skills.com
```

- 配置DNS服务器
  
所有云主机的 DNS 服务器指向云主机1（192.168.21.11）和云主机2（192.168.21.12）。

```bash
sudo nano /etc/netplan/01-static.yaml
```
修改内容
```yaml
network:
  version: 2
  ethernets:
    eth0:
      addresses:
        - [本机IP]/24
      gateway4: [网关IP]
      nameservers:
        addresses: [192.168.21.11, 192.168.21.12]  # 指向云主机1和云主机2
```

- 使配置生效
```bash
sudo netplan apply
```

- 验证DNS
```bash
systemd-resolve --status   # 查看 DNS 配置
nslookup google.com       # 测试 DNS 解析
```

- 配置SSH免密登录，所有主机执行

允许root用户SSH登录
```bash
sudo vim /etc/ssh/sshd_config
```

修改内容
```text
PermitRootLogin yes         # 允许 root 登录
PasswordAuthentication yes  # 允许密码登录（临时启用）
```

重启SSH服务
```bash
sudo systemctl restart sshd
```

生成SSH密钥对
```bash
sudo -i                      # 切换到 root 用户
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa  # 生成密钥（直接回车）
```

将公钥分发到所有主机，以云主机1为例
```bash
# 将公钥复制到所有主机（需输入密码）
ssh-copy-id root@file.2025skills.com
ssh-copy-id root@mail.2025skills.com
ssh-copy-id root@mariadb.2025skills.com
ssh-copy-id root@ntp.2025skills.com
ssh-copy-id root@monitor.2025skills.com
```

2. 创建用户群（Well Done）

步骤：
- 登录云主机1，写shell script运行即可。

创建用户组（Well Done）
```bash
sudo groupadd Guangdong  # 创建组
```

循环创建用户（Well Done）
```bash
#!/bin/bash
for i in {01..99}; do
  username="Admin$i"
  sudo useradd -m -s /bin/bash -g Guangdong $username
  echo "Guangdong2025" | sudo passwd --stdin $username
  sudo chage -W 7 $username          # 设置密码过期前7天警告
  sudo chage -M 99999 $username      # 密码永不过期
  sudo chage -E -1 $username         # 账户永不过期
done
```

验证用户创建（Well Done）
```bash
grep Guangdong /etc/group # 查看组内用户
id Admin01        # 检查用户是否存在
sudo chage -l Admin01  # 查看账户过期设置
```


3. 挂载卷及创建逻辑卷
   - 将 HT1 和 HT2 共 2 个卷挂载到“云主机 5”中，将其加入到名为“GzVG”的卷组中，
   - 从中创建一个大小为 8G 的逻辑卷“GzLV”，格式化逻辑卷为 xfs 文件系统并开机自动挂载到/mnt/HT1 目录。

步骤：
- 宿主机中将卷HT1和HT2附加到云主机5中
```bash
vmcli attach disk "云主机5" "HT1"
vmcli attach disk "云主机5" "HT2"
```

- 登录云主机5
```bash
vmrun -gu ubuntu -gp "123456" runProgramInGuest "C:\VMs\云主机5\云主机5.vmx" "/usr/bin/sudo" "bash"
```

查看附加的磁盘
```bash
lsblk
```

安装工具
```bash
sudo apt install xfsprogs lvm2 -y
```

创建物理卷PV
```bash
sudo pvcreate /dev/sdb /dev/sdc  # 假设 HT1= sdb，HT2= sdc
```

创建卷组VG
```bash
sudo vgcreate GzVG /dev/sdb /dev/sdc
```

创建逻辑卷LV
```bash
sudo lvcreate -L 8G -n GzLV GzVG
```

格式化为xfs文件系统
```bash
sudo mkfs.xfs /dev/GzVG/GzLV
```

创建挂载点并挂载
```bash
sudo mkdir -p /mnt/HT1
sudo mount /dev/GzVG/GzLV /mnt/HT1
```

设置开机自动挂载
```bash
sudo vim /etc/fstab
```

或者追加内容
```bash
echo '
/dev/GzVG/GzLV /mnt/HT1 xfs defaults 0 0
' >> /etc/fstab
```

验证挂载
```bash
df -h /mnt/HT1  # 查看挂载状态
sudo reboot     # 重启后验证自动挂载
```
### 任务三

配置云主机1为主域名服务器（Bind 9）

安装Bind 9
```bash
# 登录云主机1（dns.2025skills.com）
ssh root@dns.2025skills.com

# 更新系统并安装 Bind9
sudo apt update
sudo apt install bind9 -y
```

配置主域名服务器
```bash
sudo vim /etc/bind/named.conf.local
```

添加以下内容
```bash
// 定义正向区域
zone "2025skills.com" {
    type master;
    file "/etc/bind/zones/db.2025skills.com";  // 正向区域文件
    allow-transfer { 192.168.21.12; };          // 允许备份服务器同步
    also-notify { 192.168.21.12; };             // 通知备份服务器
};

// 定义反向区域（根据子网配置三个反向区域）
zone "21.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.192.168.21";       // 反向区域文件（Vlan301）
    allow-transfer { 192.168.21.12; };
};

zone "22.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.192.168.22";       // 反向区域文件（Vlan302）
    allow-transfer { 192.168.21.12; };
};

zone "23.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.192.168.23";       // 反向区域文件（Vlan303）
    allow-transfer { 192.168.21.12; };
};
```

创建区域文件目录
```bash
sudo mkdir /etc/bind/zones
```

创建正向区域文件
```bash
sudo vim /etc/bind/zones/db.2025skills.com
```

内容如下：
```bash
$TTL 86400
@       IN      SOA     dns.2025skills.com. admin.2025skills.com. (
                          2024052001 ; Serial
                          3600       ; Refresh
                          1800       ; Retry
                          604800     ; Expire
                          86400      ; Minimum TTL
                          )
@       IN      NS      dns.2025skills.com.
@       IN      NS      file.2025skills.com.

dns     IN      A       192.168.21.11
file    IN      A       192.168.21.12
mail    IN      A       192.168.22.13
mariadb IN      A       192.168.22.14
ntp     IN      A       192.168.23.15
monitor IN      A       192.168.23.16
```

创建反向区域文件，以db.192.168.21为例
```bash
sudo vim /etc/bind/zones/db.192.168.21
```

内容如下：
```bash
$TTL 86400
@       IN      SOA     dns.2025skills.com. admin.2025skills.com. (
                          2024052001 ; Serial
                          3600       ; Refresh
                          1800       ; Retry
                          604800     ; Expire
                          86400      ; Minimum TTL
                          )
@       IN      NS      dns.2025skills.com.
@       IN      NS      file.2025skills.com.

11      IN      PTR     dns.2025skills.com.
12      IN      PTR     file.2025skills.com.
```

同理：
创建 db.192.168.22（对应 IP 13、14）
创建 db.192.168.23（对应 IP 15、16）

验证配置
```bash
# 检查配置文件语法
sudo named-checkconf

# 重启 Bind9
sudo systemctl restart bind9

# 查看服务状态
sudo systemctl status bind9
```





配置云主机2为备份域名服务器

安装Bind 9
```bash
# 登录云主机2（file.2025skills.com）
ssh root@file.2025skills.com

# 安装 Bind9
sudo apt update
sudo apt install bind9 -y
```

配置备份服务器

编辑主配置文件
```bash
sudo vim /etc/bind/named.conf.local
```

内容如下：
```bash
// 正向区域配置（从主服务器同步）
zone "2025skills.com" {
    type slave;
    file "/var/named/slaves/db.2025skills.com";  // 区域文件存储路径
    masters { 192.168.21.11; };                   // 主服务器IP
};

// 反向区域配置（同步三个子网）
zone "21.168.192.in-addr.arpa" {
    type slave;
    file "/var/named/slaves/db.192.168.21";
    masters { 192.168.21.11; };
};

zone "22.168.192.in-addr.arpa" {
    type slave;
    file "/var/named/slaves/db.192.168.22";
    masters { 192.168.21.11; };
};

zone "23.168.192.in-addr.arpa" {
    type slave;
    file "/var/named/slaves/db.192.168.23";
    masters { 192.168.21.11; };
};
```

创建同步目录并设置权限
```bash
sudo mkdir -p /var/named/slaves
sudo chown bind:bind /var/named/slaves
```

重启服务
```bash
sudo systemctl restart bind9
sudo systemctl status bind9
```


配置TSIG密钥认证

主服务器上生成TSIG密钥

```bash
# 登录云主机1（dns.2025skills.com）
sudo su -  # 切换到 root 用户
dnssec-keygen -a HMAC-SHA256 -b 256 -n HOST tsig-key
```

提取密钥值

```bash
# 查看生成的密钥文件（如 Ktsig-key.+163+12345.key）
cat Ktsig-key.*.key

# 记录密钥值（例如：GuR7Z4Q4kLm5T...）
# 输出示例：tsig-key. IN KEY 512 3 163 GuR7Z4Q4kLm5T...
```


主服务器上配置TSIG
```bash
sudo vim /etc/bind/tsig-key.conf
```

内容如下：
```bash
key "tsig-key" {
    algorithm hmac-sha256;
    secret "GuR7Z4Q4kLm5T...";
};
```

引用密钥文件，在文件末尾添加
```bash
sudo vim /etc/bind/named.conf

# 文件末尾添加
include "/etc/bind/tsig-key.conf";
```

修改区域配置限制传输

```bash
sudo vim /etc/bind/named.conf.local

# 修改allow-transfer
allow-transfer { key "tsig-key"; };  // 仅允许通过密钥传输
```

重启Bind 9

```bash
sudo systemctl restart bind9
```

备份服务器配置TSIG
```bash
# 在主服务器操作
scp /etc/bind/tsig-key.conf root@file.2025skills.com:/etc/bind/
```

在备份服务器引用密钥文件
```bash
sudo vim /etc/bind/named.conf

# 文件末尾添加
include "/etc/bind/tsig-key.conf";
```

修改区域配置使用密钥
```bash
sudo vim /etc/bind/named.conf.local

# 修改master
masters { 192.168.21.11 key "tsig-key"; };  // 使用密钥连接主服务器
```


重启Bind 9
```bash
sudo systemctl restart bind9
```

验证DNS解析
```bash
# 在任意主机测试正向解析
dig dns.2025skills.com @192.168.21.11

# 测试反向解析
dig -x 192.168.21.11 @192.168.21.11
```
验证区域同步
```bash
# 在备份服务器检查同步文件
ls /var/named/slaves/  # 应看到 db.2025skills.com 等文件
```

验证TSIG密钥
```bash
# 在主服务器查看传输日志
sudo tail -f /var/log/syslog | grep transfer
# 正常应显示 "transfer of '2025skills.com/IN' from 192.168.21.12#53: Transfer completed"
```



如果出错，ufw应该开放端口，时间同步应该一致

开放端口
```bash
sudo ufw allow 53/tcp
sudo ufw allow 53/udp
```


时间同步
```bash
sudo apt install ntp -y
sudo systemctl restart ntp
```

