# Linux防火墙

## 1.Linux防火墙

经常说的Linux防火墙其实是指Linux下的Netfilter/iptables.它是Linux内核集成的IP信息包过滤系统。

所谓Netfilter与iptables是Linux IP信息包过滤系统的两个组件，Netfilter是内核的模块实现，iptables是上层的操作工具。

iptables实现的不仅仅是包过滤的功能，而是通过Netfilter实现了一整套框架结构，在这个框架之上实现了包过滤、NAT等模块的功能。

Iptables和ip6tables用于在Linux内核中设置、维护和检查IPv4和IPv6数据包过滤规则表。可以定义几个不同的表。每个表都包含许多内置链也可以包含用户定义的链。

每个链都是一个规则列表，可以匹配一组数据包。每个规则指定如何处理匹配的数据包。这称为“目标”，它可能是到同一表中用户定义链的跳转。



## 2.Linux防火墙的四种有效状态

- **ESTABLISHED** 表示该信息包属于已建立的连接，该连接一直用于发送和接收信息包并且完全有效。
- **INVALID** 表示该信息包与任何已知的流或连接都不相关联，它可能包含了错误的数据或头。
- **NEW** 表示该信息包已经或即将启动新的连接，或者它与尚未用于发送的和接收信息包的连接相关联。
- **RELATED** 表示该信息包正在启动新连接，以及它与建立的连接相关联的连接。



## 3.Linux防火墙语法

对于Linux而言，数据报的流向如下：

- PREROUTING --> FORWARD --> POSTROUTING
- PREROUTING --> INPUT --> 本机OUTPUT --> POSTROUTING

分别对应iptables工作的两种模式： 

- NAT路由器
- 主机防火墙（主要用途）

iptables会根据不同的数据处理包处理功能使用不同的规则表。分别是filter、nat、mangle、raw、security

- **filter** 是默认的表，包含真正的防火墙过滤规则。内建的规则链包括：INPUT输入（用于发送到本地套接字的数据包）、OUTPUT（用于本地套接字）、FORWARD（用于通过盒子路由的数据包）。

  值得注意的是，如果没有-t 选项，则默认使用filter规则表。

- **nat** 表当遇到创建新连接的数据包时，将参考此表。它由四个内置组件组成：预路由（用于在数据包进入时改变数据包）、输入（用于改变目的地的数据包对于本地套接字），OUTPUT输出（用于在路由之前更改本地生成的数据包）和POSTROUTING后路由（用于在数据包即将离开时更改数据包）。IPv6 NAT支持从内核3.7开始提供。其包含源、目的地址及端口转换使用的规则。

- **mangle** 表包含用于设置特殊的数据包路由标志的规则。随后的filter表中的规则会检查这些标志。内建的规则链包括：PREROUTING预路由（用于在路由之前更改传入数据包）、OUTPUT输出（用于更改本地生成的数据包）、FORWARD转发（用于更改通过盒子路由的数据包）、POSTROUTING后路由（用于在即将外出时更改数据包）和INPUT输入（用于进入盒子本身的数据包）。

  值得注意的是在内核2.4.17之前，前两个规则链是它内置的。而在2.4.18之后，便开始新增为5个规则链。

- **raw** 表主要用于与NOTRACK目标一起配置连接跟踪豁免。它以更高的优先级在netfilter挂钩处注册，因此在ip连接之前被调用

  ntrack或任何其他IP表。它提供以下内置链：PREROUTING预路由（用于通过任何网络接口到达的数据包）OUTPUT输出（用于本地进程生成的数据包）。

- **security** 表用于强制访问控制（MAC）网络规则，例如由SECMARK和CONNSECMARK目标启用的规则。强制访问控制由Linux安全模块实现，例如SELinux。安全表在筛选器表之后调用，允许筛选器表中的任意访问控制（DAC）规则在MAC规则之前生效。此表提供了以下内置功能链：INPUT输入（用于进入盒子本身的数据包）、OUTPUT输出（用于在路由之前更改本地生成的数据包）和FORWARD转发（用于更改通过盒子路由的数据包）。（centos7才开始有）

表中对应的相关规则链的功能如下：

- **INPUT** 链：当一个数据包由内核中的路由计算确定为本地的Linux系统后，它会通过INPUT链的检查。
- **OUTPUT** 链：保留给系统自身生成的数据包
- **FORWARD** 链： 经过Linux系统路由的数据包（即当iptables防火墙用于连接两个网络时，两个网络之间的数据包必须流经该防火墙）
- **PREROUTING** 链：用于修改目的地址（DNAT）。
- **POSTROUTING** 链：用于修改源地址 （SNAT）。



### iptables脚本写法：

```shell
iptables [-t 表名] <-A | I | D | R> 链名[规则编号] [-i | o 网卡名称] [-p 协议类型] [-s 源IP地址 | 源子网] [--sport 源端口号] [-d 目标IP地址] [--dport 目标端口号] <-j 动作>
```

```shell
SYNOPSIS
       iptables [-t table] {-A|-C|-D} chain rule-specification

       ip6tables [-t table] {-A|-C|-D} chain rule-specification

       iptables [-t table] -I chain [rulenum] rule-specification

       iptables [-t table] -R chain rulenum rule-specification

       iptables [-t table] -D chain rulenum

       iptables [-t table] -S [chain [rulenum]]

       iptables [-t table] {-F|-L|-Z} [chain [rulenum]] [options...]

       iptables [-t table] -N chain

       iptables [-t table] -X [chain]

       iptables [-t table] -P chain target

       iptables [-t table] -E old-chain-name new-chain-name

       rule-specification = [matches...] [target]

       match = -m matchname [per-match-options]

       target = -j targetname [per-target-options]

```



## 4.iptables

### 1.功能：

防火墙规则指定数据包和目标的标准。如果数据包不匹配，则检查链中的下一条规则；如果匹配，则下一个规则由目标的值指定，该值可以是用户定义链的名称、iptables扩展（8）中描述的目标之一或特殊值ACCEPT、DROP或RETURN之一。

ACCEPT意味着让数据包通过。DROP的意思是把包扔在地板上。RETURN表示停止遍历此链，并在上一个（调用）链中的下一个规则处恢复。

如果内置链的末端是已到达或内置链中的规则与目标返回匹配，则链策略指定的目标将决定数据包的命运。

```shell
命令

这些选项指定要执行的所需操作。除非下面另有说明，否则只能在命令行上指定其中一个。对于命令和选项名称的长版本，只需使用足够的字母即可

确保iptables能够将其与所有其他选项区分开来。

-A、 --附加链规则规范

将一个或多个规则附加到选定链的末尾。当源和/或目标名称解析为多个地址时，将为每个可能的地址组合添加规则。

-C、 --检查链规规格

检查所选链中是否存在与规范匹配的规则。此命令使用与-D相同的逻辑来查找匹配的条目，但不改变现有的iptables配置并使用其

表示成功或失败的退出代码。

-D、 --删除链规则规范

-D、 --删除链规则数

从选定链中删除一个或多个规则。此命令有两个版本：可以将规则指定为链中的数字（第一个规则从1开始）或要匹配的规则。

-一、 --插入链[rulenum]规则规范

在选定链中插入一个或多个规则作为给定的规则编号。因此，如果规则编号为1，则将在链的开头插入一个或多个规则。如果未指定规则编号，这也是默认值。

-R、 --替换链规则num规则规范

替换所选链中的规则。如果源和/或目标名称解析为多个地址，则该命令将失败。规则从1开始编号。

-五十、 --列表[链]

列出所选链中的所有规则。如果未选择任何链，则列出所有链。与其他所有iptables命令一样，它应用于指定的表（默认为filter），因此NAT规则按

iptables-t nat-n-L

请注意，它通常与-n选项一起使用，以避免长时间的反向DNS查找。指定-Z（零）选项也是合法的，在这种情况下，链将按原子顺序列出并归零。

确切的输出受给定的其他参数的影响。在使用之前，精确的规则将被抑制

iptables-L-v

或iptables保存（8）。

-S、 --列表规则[链]

打印所选链中的所有规则。如果未选择任何链，则所有链都将像iptables save一样打印。与其他所有iptables命令一样，它应用于指定的表（默认为filter）。

-F、 --齐平[链]

刷新所选链（如果未给出任何链，则表中的所有链）。这相当于逐个删除所有规则。

-Z、 --零[链[rulenum]]

将所有链中的数据包和字节计数器归零，或仅将给定链或链中的给定规则归零。指定-L，--list（list）选项也是合法的，以便在计数器运行之前立即查看计数器

清除(见上文。）

-N、 ——新链条

按给定名称创建新的用户定义链。必须已经没有该名称的目标。

-十、 --删除链[链]

删除指定的可选用户定义链。不能有对链的引用。如果存在，则必须先删除或替换引用规则，然后才能删除链。链条必须是空的，

i、 不包含任何规则。如果没有给出参数，它将尝试删除表中的每个非内置链。
```



```
参数

以下参数构成规则规范（在添加、删除、插入、替换和追加命令中使用）。

-4，-ipv4

此选项在iptables和iptables还原中无效。如果将使用-4选项的规则与ip6tables restore一起插入（并且仅与ip6tables restore一起插入），则该规则将被静默忽略。任何其他使用都会抛出错误。此操作

tion允许在单个规则文件中使用IPv4和IPv6规则，以用于iptables还原和ip6tables还原。

-6，--ipv6

如果使用-6选项的规则与iptables restore一起插入（并且仅与iptables restore一起插入），则该规则将被静默忽略。任何其他使用都会抛出错误。此选项允许在单个规则文件中使用IPv4和IPv6规则

使用iptables restore和ip6tables restore。此选项在ip6tables和ip6tables还原中无效。

[!] -p、 --协议

要检查的规则或数据包的协议。指定的协议可以是tcp、udp、udplite、icmp、icmpv6、esp、ah、sctp、mh或特殊关键字“all”中的一个，也可以是一个数值，表示一个

这些协议的一个或另一个。还允许使用/etc/protocols中的协议名称。A“！”协议反转测试之前的参数。数字零等于所有。”“全部”将与所有专业人员匹配

tocols和在省略此选项时作为默认值。请注意，在ip6tables中，不允许使用除esp之外的IPv6扩展头。esp和ipv6 nonext可与内核版本2.6.11或更高版本一起使用。数字

ber 0等同于all，这意味着您无法直接测试协议字段的值0。要匹配HBH头，即使它是最后一个，也不能使用-p0，但始终需要-mHBH。

[!] -s、 --源地址[/mask][，…]

源规范。地址可以是网络名称、主机名、网络IP地址（带/mask）或普通IP地址。在将规则提交到内核之前，主机名将只解析一次。

请注意，指定任何要通过远程查询（如DNS）解析的名称是一个非常糟糕的主意。该掩码可以是ipv4网络掩码（用于iptables）或普通数字，用于指定位置1的数量

网络掩码的左侧。因此，24的iptables掩码相当于255.255.255.0。A“！”地址规范之前的参数反转地址的意义。标志--src是此的别名

选项可以指定多个地址，但这将扩展为多个规则（使用-A添加时），或者将导致删除多个规则（使用-D）。

[!] -d、 --目标地址[/mask][，…]

目的地规范。有关语法的详细说明，请参见-s（source）标志的说明。标志--dst是此选项的别名。

-m、 --比赛

指定要使用的匹配项，即测试特定属性的扩展模块。匹配集构成了调用目标的条件。按照上的指定，从第一个匹配项到最后一个匹配项进行计算

命令行和命令行以短路方式工作，即，如果一个扩展产生false，则评估将停止。

-j、 --跳靶

这指定了规则的目标；i、 例如，如果数据包与之匹配，该怎么办。目标可以是用户定义的链（而不是该规则所在的链），它是决定命运的特殊内置目标之一

数据包的扩展（见下面的扩展）。如果在规则中省略了此选项（并且未使用-g），则匹配规则对数据包的命运没有影响，但

规则将递增。

-g、 --跳转链

这指定处理应在用户指定的链中继续。与--jump选项不同，返回将不会继续在此链中处理，而是在通过--jump调用我们的链中处理。

[!] -i、 --在接口名称中

接收数据包的接口名称（仅适用于进入输入、转发和预路由链的数据包）。当“！”参数在接口名称之前使用，其含义是颠倒的。如果

接口名以“+”结尾，则以该名称开头的任何接口都将匹配。如果省略此选项，则任何接口名称都将匹配。
[!] -o、 --输出接口名称

将通过其发送数据包的接口的名称（对于进入前向、输出和后向路由链的数据包）。当“！”参数在接口名称之前使用，其含义是颠倒的。如果

接口名称以“+”结尾，则以该名称开头的任何接口都将匹配。如果省略此选项，则任何接口名称都将匹配。

[!] -f、 --碎片

这意味着该规则只引用碎片数据包的第二个和更多IPv4片段。由于无法确定此类数据包（或ICMP类型）的源端口或目标端口，因此此类数据包将不匹配任何指定它们的规则。当“！”参数在“-f”标志之前，规则将只匹配头片段或未分段的数据包。此选项特定于IPv4，在ip6tables中不可用。

-c、 --设置计数器数据包字节

这使管理员能够初始化规则的数据包和字节计数器（在插入、追加、替换操作期间）。
```
```shell
其他选择

可以指定以下附加选项：

-v、 --冗长

详细输出。此选项使list命令显示接口名称、规则选项（如果有）和TOS掩码。还列出了数据包和字节计数器，后缀“K”、“M”或“G”表示1000，

1000000和100000000乘法器（但请参见-x标志以更改此设置）。对于追加、插入、删除和替换，这将导致打印有关规则的详细信息-v

可以多次指定，以可能发出更详细的调试语句。

-w、 --等等[秒]

等待xtables锁。为了防止程序的多个实例同时运行，将尝试在启动时获取独占锁。默认情况下，如果无法锁定，程序将退出

获得。此选项将使程序等待（无限期或可选秒），直到获得独占锁。

-W、 --等待间隔微秒

每次迭代等待的时间间隔。在运行对延迟敏感的应用程序时，可能无法接受长时间等待xtables锁。此选项将使每次迭代都采用

指定的时间。默认间隔为1秒。此选项仅适用于-w。

-n、 --数字

数字输出。IP地址和端口号将以数字格式打印。默认情况下，程序将尝试将它们显示为主机名、网络名或服务（只要适用）。

-x、 --准确

展开数字。显示数据包和字节计数器的精确值，而不是仅以K（1000的倍数）M（1000K的倍数）或G（1000M的倍数）为单位的四舍五入数字。此选项仅适用于

代表-L命令。

--行号

列出规则时，将行号添加到每个规则的开头，对应于该规则在链中的位置。

--modprobe=命令

在向链中添加或插入规则时，使用命令加载任何必要的模块（目标、匹配扩展等）。
```



### 2.动作说明

- **ACCEPT** ： 接收数据包
- **DROP** ： 丢弃数据包
- **REDIRECT** ： 将数据包重新转向到本机或另一台主机的某一个端口，通常实现透明代理或对外开放内网的某些服务
- **REJECT** ： 拦截该数据封包，并发回封包通知对方
- **SNAT** ： 源地址转换，即改变数据包的源地址。例如：将局域网的IP（10.0.0.1/24）转换为广域网的IP（203.93.236.141/24），在NAT表的POSTROUTING链上进行该动作。
- **DNAT** ： 目标地址转换，即改变数据包的目标地址。例如：将广域网的IP（203.93.236.141/24）转换为局域网的（10.0.0.1/24），在NAT表的PREROUTING链上进行该动作。
- **MASQUERADE** ： IP伪装，即常说的NAT技术，MASQUERADE只能用于ADSL等拨号上网的IP伪装，也就是主机的IP是由ISP动态分配的，如果主机的IP地址是静态固定的，就要使用SNAT。
- **LOG** ： 日志功能，将符合规则的数据包的相关信息记录在日志中，以便管理员的分析和排错。



### 3.状态说明

- **NEW** ： 如果你的主机向远程机器发送一个连接请求，那么这个数据包的状态就是NEW。
- **ESTABLISHED** ： 在连接建立之后（完成TCP的三次握手后），远程主机和你的主机通信数据的状态为**ESTABLISHED** 。
- **RELATED** ： 和现有的联机相关的新联机封包。比如FTP服务，用21端口进行身份验证之后传送命令，20端口上传送的数据的状态就是RELATED。
- **INVALID** ： 无效的数据包，不能被识别属于哪个连接或没有任何状态，通常这种状态的数据包会被丢弃。



## 5.iptables脚本书写测试

一般我们测试iptables的写法可以用云服务器来做一个测试，但是为了防止意外操作，通常会加多一个crontab计划任务，防止因为自己误操作而导致22端口被禁止要重新到机房重启服务器。当然在调试完毕之后，认为没有问题就可以停止这个Crontab作业了。

```shell
*/5 * * * * /etc/init.d/iptables stop
```

**这个脚本并不适用于每一个Linux系统，具体情况具体分析，可以用whereis或者查看进程来看iptables位置。**

这样计划任务便会每5分钟停止iptables服务一次。建议还是自己开一个简易的环境来测试一波。



编写iptables脚本的思路非常清晰，先把所有进入主机的数据包都丢弃掉，然后根据自己的需求，逐步开放相应的端口以及添加合适的规则！！！



如果你是那种禁止其他主机向该主机发送任何连接请求的，你可以写：

```shell
iptables -A INPUT -m state --state NEW -j DROP
```

如何来解读呢？

那就是将发送到该主机的所有数据包（状态为NEW的包）全部丢弃。但是主机确实可以主动连接其他机器。那现在让所有已经建立连接的数据通过：

```shell
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```



这样我们可以为自己的个人主机配置一个相对安全的规则，即是我们可以随意访问Internet，但是外部却不能主动发起对我们机器的连接。（这样就说明你可能无法远程连接你的电脑）请注意，它是原先的连接不会断开，而作用于脚本执行后的连接。禁止用于生产服务器，会默认拒绝一切连接的！！

```shell
#!/bin/bash
#这是一个相对安全的数据包过滤规则，仅能主动发起连接，无法被动接收连接。
#前面的规则都是负责把全部数据包都丢弃，只能接收自己发送连接的数据包。
iptables -F
iptables -F -t nat
iptables -X
iptables -Z
iptables -P INPUT DROP
iptables -A INPUT -m state --state NEW -j DROP
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

```shell
iptables -nv -L
//查看iptables规则
```

### **清空所有的表链规则，初始化**

```shell
iptabels -F
iptabels -X
iptabels -Z
iptabels -F -t nat
iptabels -X -t nat
iptabels -Z -t nat
iptabels -X -t mangle
```

可以把它写成脚本的格式去执行，以便自己去调试。

### 按需求调整系统内核

开启SYN缓冲：

```shell
echo "1" > /proc/sys/net/ipv4/tcp_syncookies
```

作为NAT路由器，开启IP转发功能，用于多网卡之间的数据的流通：

```shell
echo "1" > /proc/sys/net/ipv4/ip_forward
```

### 加载iptables模块

```shell
modprobe ip_tables
modprobe iptabels_nat
modprobe ip_nat_ftp
modprobe ip_nat_irc
modprobe nf_conntrack
modprobe ip_conntrack_ftp
modprobe ipt_MASQUERADE
```

### 查看已加载的模块

```shell
lsmod | grep "ip"
//可以查看加载的模块
```

### 防止SYN轻量级攻击

```shell
iptables -N syn-flood
iptables -A INPUT -p tcp --syn -j syn-flood
iptables -I syn-flood -p tcp -m limit --limit 3/s --limit-burst 6 -j RETURN
iptables -A syn-flood -j REJECT
```

### 防止DOS轻量级攻击

```shell
iptables -A INPUT -i eth0 -p tcp --syn -m connlimit --connlimit-above 15 -j DROP
iptables -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT
```

### 防止DDOS轻量级攻击

```shell
iptables -A INPUT -p tcp --syn -m limit --limit 12/s --limit-burst 24 -j ACCEPT
iptables -A FORWARD -p tcp --syn -m limit --limit 1/s -j ACCEPT
```

###  利用recent模块限制同一IP的连接数

```shell
iptables -I INPUT -p tcp --dport 80 -m state --state NEW -m recent --name web --set 
iptables -A INPUT -m recent --update --name web --seconds 60 --hitcount 20 -j LOG --log-prefix 'HTTP attack: '
iptabels -A INPUT -m recent --update --name web --seconds 60 --hitcount 20 -j DROP
```

### 屏蔽IP

```shell
iptables -I INPUT -s 123.45.6.7 -j DROP       #屏蔽单个IP的命令
iptables -I INPUT -s 123.0.0.0/8 -j DROP      #封整个段即从123.0.0.1到123.255.255.254的命令
iptables -I INPUT -s 124.45.0.0/16 -j DROP    #封IP段即从123.45.0.1到123.45.255.254的命令
iptables -I INPUT -s 123.45.6.0/24 -j DROP    #封IP段即从123.45.6.1到123.45.6.254的命令是
```

### 开放指定的端口

```shell
iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT               #允许本地回环接口(即运行本机访问本机)
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT    #允许已建立的或相关连的通行
iptables -A OUTPUT -j ACCEPT         #允许所有本机向外的访问
iptables -A INPUT -p tcp --dport 22 -j ACCEPT    #允许访问22端口
iptables -A INPUT -p tcp --dport 80 -j ACCEPT    #允许访问80端口
iptables -A INPUT -p tcp --dport 21 -j ACCEPT    #允许ftp服务的21端口
iptables -A INPUT -p tcp --dport 20 -j ACCEPT    #允许FTP服务的20端口
iptables -A INPUT -j reject       #禁止其他未允许的规则访问
iptables -A FORWARD -j REJECT     #禁止其他未允许的规则访问
```





## 6.总结

- iptables防火墙并不能阻止DDos攻击，线上生产项目建议还是采购硬件防火墙，置于整个系统之前，防止DDos攻击以及端口映射，当然如果资金允许，还是购买那些大厂的防火墙设施，毕竟别人就是做这个，研究这个的。
- 建议在生产环境中要加上应用层级的防火墙，可以防止常见的XSS、SQL注入等攻击。
- 如果线上的机器采用了集群架构，建议关闭iptables防火墙，可以提高后端服务器的网络性能，安全工作由硬件防火墙承担。
- 推荐业务方面，尽量自己的服务不要对公网开放，尽量走内网地址，比如MySQL数据库以及Redis业务等。
- 如果默认禁止一切策略，建议开启本地lo循环，采用操作系统通过回环接口来发送本地数据流，iptables脚本建议开启lo本地回环。



# UFW防火墙的使用uncomplicated firewall

检查自己是否安装ufw，默认都是在root用户下，不是的话就切换用户或是sudo

```shell
sudo ufw version
```

安装

```shell
sudo apt-get install ufw
```

启动或是关闭

```shell
sudo ufw enable
sudo ufw disable
```

关闭所有外部对本机的访问，但是本机访问外部正常

```shell
sudo ufw default deny
```

开启或禁用端口

```shell
sudo ufw allow 端口号
sudo ufw deny 端口号
//开启80端口
sudo ufw allow 80
```

值得注意的是，如果你在云服务器上测试ufw，请注意！！开启ufw之后立刻开放22端口，否则你会被系统拒绝ssh连接，而导致你要用其他方式来登入系统来修改！！！！



允许某个ip访问本机所有端口

```shell
sudo ufw allow from 192.168.222.1
```



删除规则

```shell
sudo ufw delete allow 80
```



查看防火墙状态

```shell
sudo ufw status
```



相关文件：

- 　/etc /ufw/：里面是一些ufw的环境设定文件，如 before.rules、after.rules、sysctl.conf、ufw.conf，及 for ip6 的 before6.rule 及 after6.rules。这些文件一般按照默认的设置进行就ok。
- 　若开启ufw之 后，/etc/ufw/sysctl.conf会覆盖默认的/etc/sysctl.conf文件，若你原来的/etc/sysctl.conf做了修 改，启动ufw后，若/etc/ufw/sysctl.conf中有新赋值，则会覆盖/etc/sysctl.conf的，否则还以/etc /sysctl.conf为准。当然你可以通过修改/etc/default/ufw中的“IPT_SYSCTL=”条目来设置使用哪个 sysctrl.conf.
- /var/lib/ufw/user.rules 这个文件中是我们设置的一些防火墙规则，打开大概就能看明白，有时我们可以直接修改这个文件，不用使用命令来设定。修改后记得ufw reload重启ufw使得新规则生效。

简易设置对于个人用的Linux电脑也是足够的！可以保证电脑相对安全！！
